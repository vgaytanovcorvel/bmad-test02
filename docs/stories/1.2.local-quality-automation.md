# Story 1.2: Local Quality Automation

## Status
Draft

## Story
**As a** development team,
**I want** comprehensive package scripts for linting, testing, coverage validation, and quality gates,
**so that** we can enforce consistent code quality through automated scripts and ensure reliable testing workflows before deployment.

## Acceptance Criteria
1. Package scripts exist for `lint`, `test`, `test:unit`, `test:integration`, `e2e`, `coverage`, and `build` (PNPM/Nx).
2. Coverage (unit+integration) threshold ≥85% enforced in Jest config.
3. Single `pnpm validate` script runs lint → unit+integration tests → build.
4. `pnpm e2e` documented as required before release (manual gate).
5. Quality gate documented: contributors run `pnpm validate` + `pnpm e2e` locally before merge.

## Tasks / Subtasks

- [ ] **Task 1: Configure Comprehensive Package Scripts** (AC: 1)
  - [ ] Add `lint` script: `pnpm nx run-many --target=lint --all`
  - [ ] Add `test` script: `pnpm nx run-many --target=test --all`
  - [ ] Add `test:unit` script: `pnpm nx run-many --target=test --all --testNamePattern="unit"`
  - [ ] Add `test:integration` script: `pnpm nx run-many --target=test --all --testNamePattern="integration"`
  - [ ] Add `e2e` script: `pnpm nx e2e ui-e2e`
  - [ ] Add `coverage` script: `pnpm nx run-many --target=test --all --coverage`
  - [ ] Add `build` script: `pnpm nx run-many --target=build --all`
  - [ ] Verify all scripts execute correctly in root package.json

- [ ] **Task 2: Configure Jest Coverage Thresholds** (AC: 2)
  - [ ] Set global coverage threshold ≥85% in `apps/ui/jest.config.ts`
  - [ ] Set coverage threshold ≥85% in `libs/engine/jest.config.ts`
  - [ ] Set coverage threshold ≥85% in `libs/shared/jest.config.ts`
  - [ ] Configure coverage to include both unit and integration tests
  - [ ] Verify coverage enforcement blocks builds below threshold
  - [ ] Set coverage reporters: text, html, lcov for comprehensive reporting

- [ ] **Task 3: Create Validation Pipeline Script** (AC: 3)
  - [ ] Create `validate` script that runs lint → test → build in sequence
  - [ ] Configure script to fail fast on any step failure
  - [ ] Add timing information for each validation step
  - [ ] Add colored output for clear success/failure indication
  - [ ] Test validate script with intentional failures to verify fail-fast behavior

- [ ] **Task 4: Document E2E Testing Requirements** (AC: 4)
  - [ ] Document `pnpm e2e` as mandatory pre-release step
  - [ ] Add E2E execution instructions to README.md
  - [ ] Document E2E test requirements and expected behaviors
  - [ ] Create troubleshooting guide for common E2E test failures
  - [ ] Verify E2E tests run successfully and produce clear output

- [ ] **Task 5: Implement Quality Gate Documentation** (AC: 5)
  - [ ] Create CONTRIBUTING.md with quality gate requirements
  - [ ] Document pre-merge checklist: `pnpm validate` + `pnpm e2e`
  - [ ] Add quality gate workflow documentation
  - [ ] Document failure resolution procedures
  - [ ] Add code quality standards and enforcement policies
  - [ ] Update README.md with quality assurance section

- [ ] **Task 6: Configure Testing Framework Standards** (AC: 1, 2)
  - [ ] Configure Jest for unit tests with `.spec.ts` naming convention
  - [ ] Configure Jest for integration tests with `.integration.spec.ts` naming
  - [ ] Set up test file location standards per project structure
  - [ ] Configure test setup files and global test configuration
  - [ ] Verify testing frameworks run correctly across all projects

## Dev Notes

### Previous Story Insights
Story 1.1 successfully established the Nx monorepo foundation with Angular 17+, Vite, Tailwind CSS, and basic ESLint/Prettier configuration. The workspace structure is properly configured with `apps/ui`, `libs/engine`, `libs/shared`, and `apps/ui-e2e`. All build tools are working correctly, providing a solid foundation for implementing quality automation.

### Project Structure Context
[Source: docs/ui-architecture/project-structure.md]

The quality automation scripts must work across the established project structure:
```
tic-tac-toe-showcase/
├── apps/
│   ├── ui/                          # Main Angular application (Jest config needed)
│   └── ui-e2e/                      # Playwright E2E tests (Playwright config exists)
├── libs/
│   ├── engine/                      # Game engine library (Jest config needed)
│   └── shared/                      # Shared utilities library (Jest config needed)
├── package.json                     # Root package scripts location
└── README.md                        # Documentation updates needed
```

### Testing Framework Configuration Requirements
[Source: docs/ui-architecture/testing-requirements.md]

**Unit Testing Setup:**
- Framework: Jest (Fast, comprehensive, excellent Angular integration)
- File Location: Collocated with source files using `.spec.ts` extension
- Coverage Goals: 85% threshold for unit + integration tests
- Test Structure: Arrange-Act-Assert pattern

**Integration Testing Setup:**
- Framework: @testing-library/angular (User-centric testing approach)
- File Location: Same pattern as unit tests, but testing component interactions
- Naming Convention: `.integration.spec.ts` for clear differentiation

**E2E Testing Setup:**
- Framework: Playwright (Reliable, fast, multi-browser support)
- Location: `apps/ui-e2e` using Playwright framework
- Configuration: `apps/ui-e2e/playwright.config.ts`

**Coverage Configuration Requirements:**
- Reporters: text, html, lcov for comprehensive reporting
- Threshold: ≥85% for lines, functions, branches, statements
- Include both unit and integration test coverage
- Enforce coverage gates in CI/CD pipeline preparation

### Package Script Standards
[Source: docs/ui-architecture/frontend-developer-standards.md]

Essential scripts for development workflow:
- `pnpm nx serve ui` - Development server
- `pnpm nx build ui` - Production build
- `pnpm nx test ui` - Unit tests
- `pnpm nx e2e ui-e2e` - E2E tests
- `pnpm nx lint ui` - Code linting

**Required Quality Automation Scripts:**
- `lint` - Run ESLint across all projects
- `test` - Run all unit and integration tests
- `test:unit` - Run only unit tests (`.spec.ts` files)
- `test:integration` - Run only integration tests (`.integration.spec.ts` files)
- `e2e` - Run Playwright E2E tests
- `coverage` - Generate coverage reports with threshold enforcement
- `build` - Build all projects for production
- `validate` - Sequential pipeline: lint → test → build

### Nx Configuration for Multi-Project Scripts
[Source: Previous Story Implementation Notes]

Use Nx `run-many` command for cross-project script execution:
- `pnpm nx run-many --target=lint --all` - Lint all projects
- `pnpm nx run-many --target=test --all` - Test all projects
- `pnpm nx run-many --target=build --all` - Build all projects

**Coverage Script Configuration:**
- Use `--coverage` flag with test commands
- Configure Jest in each project's `jest.config.ts`
- Set thresholds at project level for granular control

### Jest Configuration Requirements
Each project (`apps/ui`, `libs/engine`, `libs/shared`) needs Jest configuration:

```typescript
// jest.config.ts template for each project
export default {
  displayName: 'project-name',
  preset: '../../jest.preset.js',
  testEnvironment: 'jsdom',
  transform: {
    '^.+\\.[tj]s$': ['ts-jest', { tsconfig: '<rootDir>/tsconfig.spec.json' }],
  },
  moduleFileExtensions: ['ts', 'js', 'html'],
  coverageDirectory: '../../coverage/apps/project-name',
  coverageReporters: ['text', 'html', 'lcov'],
  coverageThreshold: {
    global: {
      branches: 85,
      functions: 85,
      lines: 85,
      statements: 85
    }
  },
  testMatch: [
    '<rootDir>/src/**/*.spec.ts',
    '<rootDir>/src/**/*.integration.spec.ts'
  ]
};
```

### Quality Gate Workflow Documentation
[Source: docs/ui-architecture/frontend-developer-standards.md]

**Pre-merge Quality Requirements:**
1. All code must pass `pnpm validate` (lint + test + build)
2. All E2E tests must pass `pnpm e2e`
3. Coverage threshold ≥85% must be maintained
4. No ESLint errors or warnings allowed
5. All TypeScript compilation must succeed

**Validation Pipeline Sequence:**
1. **Lint Phase** - ESLint + Prettier validation
2. **Test Phase** - Unit + Integration tests with coverage
3. **Build Phase** - Production build verification
4. **E2E Phase (Manual)** - End-to-end validation

### Testing File Organization Standards
[Source: docs/ui-architecture/testing-requirements.md]

**Unit Test Files:**
- Naming: `*.spec.ts`
- Location: Collocated with source files
- Purpose: Test individual components/services in isolation

**Integration Test Files:**
- Naming: `*.integration.spec.ts`
- Location: Collocated with source files
- Purpose: Test component interactions with services

**E2E Test Files:**
- Naming: `*.e2e-spec.ts`
- Location: `apps/ui-e2e/src/`
- Purpose: Test complete user workflows

### Coverage Reporting Configuration
- **Text Reporter** - Console output for immediate feedback
- **HTML Reporter** - Detailed coverage reports in `coverage/` directory
- **LCOV Reporter** - Machine-readable format for CI/CD integration

### Testing
[Source: docs/ui-architecture/testing-requirements.md]

**Test Script Validation Requirements:**
- All scripts must execute successfully without errors
- Coverage thresholds must be enforced and block failures
- E2E tests must run reliably in headless mode
- Test output must be clear and actionable

**Testing Framework Verification:**
- Jest configuration works across all projects
- Playwright configuration runs E2E tests successfully
- Coverage reporting generates accurate metrics
- Test file naming conventions are properly recognized

**Quality Gate Verification:**
- `validate` script fails fast on first error
- Coverage below 85% blocks script completion
- ESLint errors prevent successful validation
- Build failures are properly reported

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-25 | 1.0 | Initial story creation from Epic 1.2 | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after implementation review*