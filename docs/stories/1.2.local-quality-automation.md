# Story 1.2: Local Quality Automation

## Status
Done

## Story
**As a** development team,
**I want** comprehensive package scripts for linting, testing, coverage validation, and quality gates,
**so that** we can enforce consistent code quality through automated scripts and ensure reliable testing workflows before deployment.

## Acceptance Criteria
1. Package scripts exist for `lint`, `test`, `test:unit`, `test:integration`, `e2e`, `coverage`, and `build` (PNPM/Nx).
2. Coverage (unit+integration) threshold ≥85% enforced in Jest config.
3. Single `pnpm validate` script runs lint → unit+integration tests → build.
4. `pnpm e2e` documented as required before release (manual gate).
5. Quality gate documented: contributors run `pnpm validate` + `pnpm e2e` locally before merge.

## Tasks / Subtasks

- [x] **Task 1: Configure Comprehensive Package Scripts** (AC: 1)
  - [x] Add `lint` script: `pnpm nx run-many --target=lint --all`
  - [x] Add `test` script: `pnpm nx run-many --target=test --all`
  - [x] Add `test:unit` script: `pnpm nx run-many --target=test --all --testNamePattern="unit"`
  - [x] Add `test:integration` script: `pnpm nx run-many --target=test --all --testNamePattern="integration"`
  - [x] Add `e2e` script: `pnpm nx e2e ui-e2e`
  - [x] Add `coverage` script: `pnpm nx run-many --target=test --all --coverage`
  - [x] Add `build` script: `pnpm nx run-many --target=build --all`
  - [x] Verify all scripts execute correctly in root package.json

- [x] **Task 2: Configure Jest Coverage Thresholds** (AC: 2)
  - [x] Set global coverage threshold ≥85% in `apps/ui/jest.config.ts`
  - [x] Set coverage threshold ≥85% in `libs/engine/jest.config.ts`
  - [x] Set coverage threshold ≥85% in `libs/shared/jest.config.ts`
  - [x] Configure coverage to include both unit and integration tests
  - [x] Verify coverage enforcement blocks builds below threshold
  - [x] Set coverage reporters: text, html, lcov for comprehensive reporting

- [x] **Task 3: Create Validation Pipeline Script** (AC: 3)
  - [x] Create `validate` script that runs lint → test → build in sequence
  - [x] Configure script to fail fast on any step failure
  - [x] Add timing information for each validation step
  - [x] Add colored output for clear success/failure indication
  - [x] Test validate script with intentional failures to verify fail-fast behavior

- [x] **Task 4: Document E2E Testing Requirements** (AC: 4)
  - [x] Document `pnpm e2e` as mandatory pre-release step
  - [x] Add E2E execution instructions to README.md
  - [x] Document E2E test requirements and expected behaviors
  - [x] Create troubleshooting guide for common E2E test failures
  - [x] Verify E2E tests run successfully and produce clear output

- [x] **Task 5: Implement Quality Gate Documentation** (AC: 5)
  - [x] Create CONTRIBUTING.md with quality gate requirements
  - [x] Document pre-merge checklist: `pnpm validate` + `pnpm e2e`
  - [x] Add quality gate workflow documentation
  - [x] Document failure resolution procedures
  - [x] Add code quality standards and enforcement policies
  - [x] Update README.md with quality assurance section

- [x] **Task 6: Configure Testing Framework Standards** (AC: 1, 2)
  - [x] Configure Jest for unit tests with `.spec.ts` naming convention
  - [x] Configure Jest for integration tests with `.integration.spec.ts` naming
  - [x] Set up test file location standards per project structure
  - [x] Configure test setup files and global test configuration
  - [x] Verify testing frameworks run correctly across all projects

## Dev Notes

### Previous Story Insights
Story 1.1 successfully established the Nx monorepo foundation with Angular 17+, Vite, Tailwind CSS, and basic ESLint/Prettier configuration. The workspace structure is properly configured with `apps/ui`, `libs/engine`, `libs/shared`, and `apps/ui-e2e`. All build tools are working correctly, providing a solid foundation for implementing quality automation.

### Project Structure Context
[Source: docs/ui-architecture/project-structure.md]

The quality automation scripts must work across the established project structure:
```
tic-tac-toe-showcase/
├── apps/
│   ├── ui/                          # Main Angular application (Jest config needed)
│   └── ui-e2e/                      # Playwright E2E tests (Playwright config exists)
├── libs/
│   ├── engine/                      # Game engine library (Jest config needed)
│   └── shared/                      # Shared utilities library (Jest config needed)
├── package.json                     # Root package scripts location
└── README.md                        # Documentation updates needed
```

### Testing Framework Configuration Requirements
[Source: docs/ui-architecture/testing-requirements.md]

**Unit Testing Setup:**
- Framework: Jest (Fast, comprehensive, excellent Angular integration)
- File Location: Collocated with source files using `.spec.ts` extension
- Coverage Goals: 85% threshold for unit + integration tests
- Test Structure: Arrange-Act-Assert pattern

**Integration Testing Setup:**
- Framework: @testing-library/angular (User-centric testing approach)
- File Location: Same pattern as unit tests, but testing component interactions
- Naming Convention: `.integration.spec.ts` for clear differentiation

**E2E Testing Setup:**
- Framework: Playwright (Reliable, fast, multi-browser support)
- Location: `apps/ui-e2e` using Playwright framework
- Configuration: `apps/ui-e2e/playwright.config.ts`

**Coverage Configuration Requirements:**
- Reporters: text, html, lcov for comprehensive reporting
- Threshold: ≥85% for lines, functions, branches, statements
- Include both unit and integration test coverage
- Enforce coverage gates in CI/CD pipeline preparation

### Package Script Standards
[Source: docs/ui-architecture/frontend-developer-standards.md]

Essential scripts for development workflow:
- `pnpm nx serve ui` - Development server
- `pnpm nx build ui` - Production build
- `pnpm nx test ui` - Unit tests
- `pnpm nx e2e ui-e2e` - E2E tests
- `pnpm nx lint ui` - Code linting

**Required Quality Automation Scripts:**
- `lint` - Run ESLint across all projects
- `test` - Run all unit and integration tests
- `test:unit` - Run only unit tests (`.spec.ts` files)
- `test:integration` - Run only integration tests (`.integration.spec.ts` files)
- `e2e` - Run Playwright E2E tests
- `coverage` - Generate coverage reports with threshold enforcement
- `build` - Build all projects for production
- `validate` - Sequential pipeline: lint → test → build

### Nx Configuration for Multi-Project Scripts
[Source: Previous Story Implementation Notes]

Use Nx `run-many` command for cross-project script execution:
- `pnpm nx run-many --target=lint --all` - Lint all projects
- `pnpm nx run-many --target=test --all` - Test all projects
- `pnpm nx run-many --target=build --all` - Build all projects

**Coverage Script Configuration:**
- Use `--coverage` flag with test commands
- Configure Jest in each project's `jest.config.ts`
- Set thresholds at project level for granular control

### Jest Configuration Requirements
Each project (`apps/ui`, `libs/engine`, `libs/shared`) needs Jest configuration:

```typescript
// jest.config.ts template for each project
export default {
  displayName: 'project-name',
  preset: '../../jest.preset.js',
  testEnvironment: 'jsdom',
  transform: {
    '^.+\\.[tj]s$': ['ts-jest', { tsconfig: '<rootDir>/tsconfig.spec.json' }],
  },
  moduleFileExtensions: ['ts', 'js', 'html'],
  coverageDirectory: '../../coverage/apps/project-name',
  coverageReporters: ['text', 'html', 'lcov'],
  coverageThreshold: {
    global: {
      branches: 85,
      functions: 85,
      lines: 85,
      statements: 85
    }
  },
  testMatch: [
    '<rootDir>/src/**/*.spec.ts',
    '<rootDir>/src/**/*.integration.spec.ts'
  ]
};
```

### Quality Gate Workflow Documentation
[Source: docs/ui-architecture/frontend-developer-standards.md]

**Pre-merge Quality Requirements:**
1. All code must pass `pnpm validate` (lint + test + build)
2. All E2E tests must pass `pnpm e2e`
3. Coverage threshold ≥85% must be maintained
4. No ESLint errors or warnings allowed
5. All TypeScript compilation must succeed

**Validation Pipeline Sequence:**
1. **Lint Phase** - ESLint + Prettier validation
2. **Test Phase** - Unit + Integration tests with coverage
3. **Build Phase** - Production build verification
4. **E2E Phase (Manual)** - End-to-end validation

### Testing File Organization Standards
[Source: docs/ui-architecture/testing-requirements.md]

**Unit Test Files:**
- Naming: `*.spec.ts`
- Location: Collocated with source files
- Purpose: Test individual components/services in isolation

**Integration Test Files:**
- Naming: `*.integration.spec.ts`
- Location: Collocated with source files
- Purpose: Test component interactions with services

**E2E Test Files:**
- Naming: `*.e2e-spec.ts`
- Location: `apps/ui-e2e/src/`
- Purpose: Test complete user workflows

### Coverage Reporting Configuration
- **Text Reporter** - Console output for immediate feedback
- **HTML Reporter** - Detailed coverage reports in `coverage/` directory
- **LCOV Reporter** - Machine-readable format for CI/CD integration

### Testing
[Source: docs/ui-architecture/testing-requirements.md]

**Test Script Validation Requirements:**
- All scripts must execute successfully without errors
- Coverage thresholds must be enforced and block failures
- E2E tests must run reliably in headless mode
- Test output must be clear and actionable

**Testing Framework Verification:**
- Jest configuration works across all projects
- Playwright configuration runs E2E tests successfully
- Coverage reporting generates accurate metrics
- Test file naming conventions are properly recognized

**Quality Gate Verification:**
- `validate` script fails fast on first error
- Coverage below 85% blocks script completion
- ESLint errors prevent successful validation
- Build failures are properly reported

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-25 | 1.0 | Initial story creation from Epic 1.2 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
GitHub Copilot (Claude-3.5-Sonnet)

### Implementation Summary
Successfully implemented comprehensive local quality automation for the Tic-Tac-Toe Showcase project. All package scripts, Jest coverage configurations, validation pipelines, and documentation have been configured and tested.

### Debug Log References
- Fixed ESLint configuration paths in library projects (libs/*/eslint.config.mjs)
- Corrected Jest preset paths and coverage directory configurations
- Resolved TypeScript configuration inheritance issues
- Fixed Nx project configuration paths for proper build and test execution
- Added tslib dependencies back to library package.json files (required by dependency checker)

### Completion Notes
- ✅ All 6 tasks completed with 100% subtask completion
- ✅ Package scripts operational: lint, test, test:unit, test:integration, e2e, coverage, build, validate
- ✅ Jest coverage thresholds enforced at 85% across all projects (ui, engine, shared)
- ✅ Validation pipeline implemented with fail-fast behavior and clear output indicators
- ✅ Comprehensive documentation created (README.md sections, CONTRIBUTING.md)
- ✅ Testing framework standards established with proper naming conventions
- ✅ Quality gate workflow documented and operational

### File List
**Modified Files:**
- `package.json` - Added comprehensive package scripts with timing and visual indicators
- `apps/ui/jest.config.ts` - Added coverage thresholds and test matching patterns
- `libs/engine/jest.config.ts` - Added coverage thresholds and corrected paths
- `libs/shared/jest.config.ts` - Added coverage thresholds and corrected paths
- `libs/engine/eslint.config.mjs` - Fixed import path to root eslint config
- `libs/shared/eslint.config.mjs` - Fixed import path to root eslint config
- `libs/engine/package.json` - Re-added tslib dependency
- `libs/shared/package.json` - Re-added tslib dependency
- `libs/engine/project.json` - Corrected all path references for Nx
- `libs/shared/project.json` - Corrected all path references for Nx
- `libs/engine/tsconfig.json` - Fixed base config inheritance path
- `libs/shared/tsconfig.json` - Fixed base config inheritance path
- `libs/engine/tsconfig.lib.json` - Fixed output directory path
- `libs/shared/tsconfig.lib.json` - Fixed output directory path
- `libs/engine/tsconfig.spec.json` - Fixed output directory path and moduleResolution
- `libs/shared/tsconfig.spec.json` - Fixed output directory path and moduleResolution
- `README.md` - Added E2E testing section and Quality Assurance section with comprehensive documentation

**Created Files:**
- `CONTRIBUTING.md` - Comprehensive quality gate documentation with pre-merge checklist and failure resolution procedures

### Change Log
| Date | Version | Change | Files |
|------|---------|--------|-------|
| 2025-09-25 | 1.0 | Added comprehensive package scripts for quality automation | package.json |
| 2025-09-25 | 1.0 | Configured Jest coverage thresholds ≥85% across all projects | */jest.config.ts |
| 2025-09-25 | 1.0 | Created validation pipeline with fail-fast and timing indicators | package.json |
| 2025-09-25 | 1.0 | Fixed ESLint, Jest, and TypeScript configuration paths | libs/*/* |
| 2025-09-25 | 1.0 | Added E2E testing documentation and troubleshooting guide | README.md |
| 2025-09-25 | 1.0 | Created comprehensive quality gate documentation | CONTRIBUTING.md |
| 2025-09-25 | 1.0 | Established testing framework standards with naming conventions | */jest.config.ts |

### Status
Ready for Review

## QA Results
*This section will be populated by the QA agent after implementation review*