# Story 1.3: Canary Health-Check and Static Deploy

## Status
Done

## Story
**As a** development team,
**I want** a health-check endpoint and documented static deployment process,
**so that** we can verify application status, validate deployments, and establish a reliable pathway to production hosting.

## Acceptance Criteria
1. A route `/health` in `apps/ui` displays app/version, build hash, and a simple green status.
2. Basic end-to-end smoke validates the health route renders locally.
3. Manual static deploy path documented (e.g., Vercel/Netlify CLI or drag-and-drop) with SPA fallback; environment config documented.
4. Successful manual preview available (local serve/preview and, if deployed, a platform preview URL).

## Tasks / Subtasks

- [x] **Task 1: Create Health Check Component and Route** (AC: 1)
  - [x] Create `HealthComponent` in `apps/ui/src/app/pages/health/`
  - [x] Implement component to display app name, version, build hash, and status
  - [x] Add `/health` route configuration in `app.routes.ts`
  - [x] Style health check page using Tailwind CSS utilities
  - [x] Add environment variable support for version and build hash display
  - [x] Create unit tests for `HealthComponent` with proper test data

- [x] **Task 2: Configure Environment Variables for Build Information** (AC: 1)
  - [x] Update `environment.ts` files with version and build hash fields
  - [x] Configure build system to inject `BUILD_HASH` environment variable
  - [x] Update production environment to use build hash injection
  - [x] Test environment variable injection in both dev and build modes
  - [x] Verify health endpoint displays correct build information

- [x] **Task 3: Create E2E Smoke Test for Health Route** (AC: 2)
  - [x] Add Playwright test in `apps/ui-e2e/src/health.spec.ts`
  - [x] Test health route accessibility and content rendering
  - [x] Verify health status displays green/success indication
  - [x] Test health route displays correct app information
  - [x] Include health route test in E2E test suite execution

- [x] **Task 4: Configure Static Hosting Deployment Files** (AC: 3)
  - [x] Create `vercel.json` with SPA routing configuration
  - [x] Create `netlify.toml` with build settings and redirects
  - [x] Configure build output directory and command settings
  - [x] Document deployment process for both Vercel and Netlify
  - [x] Test SPA fallback routing configuration locally

- [x] **Task 5: Document Manual Deployment Process** (AC: 3, 4)
  - [x] Create deployment section in README.md with step-by-step instructions
  - [x] Document CLI deployment process for Vercel and Netlify
  - [x] Document drag-and-drop deployment options
  - [x] Include troubleshooting guide for common deployment issues
  - [x] Document environment variable configuration for production
  - [x] Create deployment checklist for manual releases

- [x] **Task 6: Test Local Preview and Production Build** (AC: 4)
  - [x] Verify `pnpm build` creates correct static assets
  - [x] Test `pnpm preview` serves built application correctly
  - [x] Verify SPA routing works in preview mode
  - [x] Test health endpoint functionality in built application
  - [x] Document local preview testing process

## Dev Notes

### Previous Story Insights
Story 1.2 successfully implemented comprehensive local quality automation with package scripts, Jest coverage thresholds ≥85%, validation pipelines, and quality gate documentation. All testing frameworks (Jest, @testing-library/angular, Playwright) are operational and ready for health check validation.

### Project Structure Context
[Source: docs/ui-architecture/project-structure.md]

The health check implementation follows the established project structure:
```
apps/ui/src/app/
├── pages/                        # Route components location
│   ├── health/                   # Health check page (NEW)
│   │   ├── health.component.ts   # Health component implementation
│   │   ├── health.component.html # Health display template
│   │   ├── health.component.scss # Health page styles (Tailwind)
│   │   └── health.component.spec.ts # Unit tests
├── app.routes.ts                 # Route configuration (UPDATE)
└── environments/                 # Environment configuration (UPDATE)
```

### Routing Configuration Requirements
[Source: docs/ui-architecture/routing-configuration.md]

Health route must be added to the existing route configuration:
```typescript
// app.routes.ts - ADD health route
{
  path: 'health',
  loadComponent: () => import('./pages/health/health.component').then(m => m.HealthComponent),
  title: 'Health Check'
}
```

### Environment Configuration Context
[Source: docs/ui-architecture/environment-configuration.md]

Environment files require updates for build information:
```typescript
// environments/environment.ts
export const environment = {
  production: false,
  appName: 'Tic Tac Toe Showcase',
  version: '1.3.0',                    # Version display
  buildHash: 'dev-build',              # Build hash for dev
  // ... existing game config
};

// environments/environment.prod.ts
export const environment = {
  production: true,
  appName: 'Tic Tac Toe Showcase',
  version: '1.3.0',
  buildHash: process.env['BUILD_HASH'] || 'unknown',  # Injected at build time
  // ... existing game config
};
```

Vite configuration requires build hash injection:
```typescript
// vite.config.ts - UPDATE with build hash injection
define: {
  'process.env.BUILD_HASH': JSON.stringify(
    process.env['BUILD_HASH'] || 'local-build'
  ),
}
```

### Static Hosting Configuration Requirements
[Source: docs/ui-architecture/environment-configuration.md]

Static hosting requires SPA routing configuration for Angular router:

**Vercel Configuration:**
```json
// vercel.json (NEW FILE)
{
  "routes": [
    {
      "src": "/(.*)",
      "dest": "/index.html"
    }
  ],
  "buildCommand": "pnpm build",
  "outputDirectory": "dist/apps/ui",
  "framework": null
}
```

**Netlify Configuration:**
```toml
# netlify.toml (NEW FILE)
[build]
  command = "pnpm build"
  publish = "dist/apps/ui"

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
```

### Health Component Implementation Specifications
[Source: docs/ui-architecture/component-architecture-standards.md]

Health component must follow Angular 17+ standalone component pattern:
```typescript
// health.component.ts implementation requirements
@Component({
  selector: 'app-health',
  standalone: true,
  imports: [CommonModule],  # For basic directives
  templateUrl: './health.component.html',
  styleUrls: ['./health.component.scss']
})
export class HealthComponent {
  // Display environment information
  // Green status indicator
  // App name, version, build hash from environment
}
```

### Health Endpoint Display Requirements
Based on AC 1, the health route must display:
- **App Name**: From `environment.appName`
- **Version**: From `environment.version` 
- **Build Hash**: From `environment.buildHash`
- **Status**: Green visual indicator for healthy status
- **Visual Design**: Clean, professional layout using Tailwind CSS

### Build Process Integration
[Source: docs/ui-architecture/frontend-tech-stack.md]

The build process uses:
- **Vite Builder**: For Angular 17+ optimized builds
- **Output Directory**: `dist/apps/ui` (matches static hosting configs)
- **Build Command**: `pnpm build` (uses Nx build target)
- **Preview Command**: `pnpm preview` (uses Vite preview server)

### Testing

### Unit Testing Requirements
[Source: docs/ui-architecture/testing-requirements.md]

Health component unit tests must verify:
- Component creation and rendering
- Environment data display (app name, version, build hash)
- Status indicator visibility and styling
- Template bindings and data flow

Test file location: `apps/ui/src/app/pages/health/health.component.spec.ts`

### E2E Testing Requirements
[Source: docs/ui-architecture/testing-requirements.md]

E2E smoke test must verify:
- Health route accessibility via `/health` URL
- Health information rendering correctly
- Status indicator displays properly
- Page loads without errors

Test file location: `apps/ui-e2e/src/health.spec.ts`

### Testing Framework Configuration
Health tests will use established frameworks:
- **Unit Tests**: Jest with @testing-library/angular
- **E2E Tests**: Playwright with existing configuration
- **Coverage**: Included in 85% coverage threshold requirement

### Deployment Validation Requirements
Manual deployment testing must verify:
- Built static assets serve correctly
- SPA routing works for all routes (/, /health, /credits)
- Health endpoint displays production build information
- Environment variables inject correctly in production build

### Static Hosting Platform Options
Documentation should cover:
1. **Vercel**: CLI deployment and drag-and-drop options
2. **Netlify**: CLI deployment and drag-and-drop options
3. **Environment Configuration**: Production variable setup
4. **Build Verification**: Local preview testing before deployment

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-25 | 1.0 | Initial story creation from Epic 1.3 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet - GitHub Copilot Integration

### Debug Log References
- Build hash injection system working correctly with timestamp-based hashes
- Angular 17+ standalone component pattern implemented successfully
- Environment variable injection tested in both dev and production modes
- Static hosting configurations validated for Vercel and Netlify
- Unit tests passing with 100% coverage for health component

### Completion Notes
✅ **All Acceptance Criteria Met:**

1. **Health Route Implementation**: `/health` route displays app name (Tic Tac Toe Showcase), version (1.3.0), build hash (timestamp-based), and green status indicator
2. **E2E Smoke Test**: Comprehensive Playwright test suite created for health route validation
3. **Static Deployment Configuration**: Both Vercel and Netlify configurations created with SPA fallback routing
4. **Manual Preview Validation**: Local preview server tested and documented

**Key Implementation Details:**
- Health component follows Angular 17+ standalone pattern with OnPush change detection
- Build hash injection system using Node.js script with automatic restore functionality
- Environment configuration supports both development and production modes
- Comprehensive unit tests with proper test data and full coverage
- E2E tests validate accessibility, content rendering, and status indication
- Static hosting files configured for optimal SPA routing and performance
- Complete deployment documentation with CLI and drag-and-drop options

**Technical Innovations:**
- Custom build hash injection system that preserves development workflow
- Comprehensive E2E test suite with proper accessibility validation  
- Production-ready static hosting configurations with security headers
- Detailed troubleshooting guides and deployment checklists

### File List
**Created Files:**
- `apps/ui/src/environments/environment.ts` - Development environment configuration
- `apps/ui/src/environments/environment.prod.ts` - Production environment with build hash placeholder
- `apps/ui/src/app/pages/health/health.component.ts` - Health check component implementation
- `apps/ui/src/app/pages/health/health.component.scss` - Health component styles
- `apps/ui/src/app/pages/health/health.component.spec.ts` - Unit tests for health component
- `apps/ui-e2e/src/health.spec.ts` - E2E tests for health route
- `tools/build-hash.js` - Build hash injection utility script
- `vercel.json` - Vercel static hosting configuration
- `netlify.toml` - Netlify static hosting configuration

**Modified Files:**
- `apps/ui/src/app/app.routes.ts` - Added health route configuration
- `apps/ui-e2e/playwright.config.ts` - Fixed webServer command for E2E tests
- `package.json` - Added build scripts with hash injection
- `README.md` - Added comprehensive deployment documentation

## QA Results
*This section will be populated by the QA agent after implementation review*