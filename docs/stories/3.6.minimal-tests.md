# Story 3.6: Minimal Tests

## Status
Ready for Review

## Story
**As a** developer working on the tic-tac-toe application,
**I want** comprehensive test coverage for UI components and computer player functionality,
**so that** I can ensure the application works correctly and computer opponent makes optimal moves.

## Acceptance Criteria
1: Component test covers rendering & simple X win scenario.
2: Engine test ensures computer chooses optimal forced win when available.

## Tasks / Subtasks

- [x] **Task 1: Create Component Integration Tests** (AC: 1)
  - [x] Set up GameBoardComponent integration test with TestBed and Testing Library
  - [x] Test component renders 3x3 grid correctly with proper test IDs
  - [x] Test human player can make moves by clicking empty cells
  - [x] Test X win scenario with winning line highlighting (positions [0,1,2])
  - [x] Test game status updates correctly during X win scenario
  - [x] Test board becomes disabled after game ends
  - [x] Test current player indicator updates correctly

- [x] **Task 2: Create Computer Player Optimization Tests** (AC: 2)
  - [x] Set up ComputerPlayer unit tests with mock GameEngine
  - [x] Test computer recognizes and takes immediate win opportunity
  - [x] Test computer blocks opponent's immediate win threat
  - [x] Test computer chooses optimal move when multiple options exist
  - [x] Test computer handles edge cases (full board, game over states)
  - [x] Verify computer move selection is deterministic for testing

- [x] **Task 3: Integration Test Coverage Enhancement**
  - [x] Add GameService integration tests covering human vs computer gameplay
  - [x] Test complete game flow from start to finish with computer opponent
  - [x] Test board size changes work correctly with computer player
  - [x] Test game reset functionality maintains computer player behavior
  - [x] Verify all game modes (HvH, HvC) work with test coverage

## Dev Notes

### Previous Story Insights
Stories 3.1-3.5 have established the complete UI integration with GameBoardComponent, GameStatusComponent, GameControlsComponent, and visual enhancements. The computer player integration from Epic 2 stories is complete with optimal move selection. All components use proper test IDs and accessibility attributes.

[Source: docs/stories/3.2.board-and-interaction.md, docs/stories/3.3.mode-and-size-controls.md, docs/stories/2.6.computer-player-integration.md]

### Testing Framework and Architecture
[Source: docs/architecture/ADR-001-tech-stack.md#testing-infrastructure]

**Jest Configuration:**
- **Framework**: Jest with Angular testing utilities and @testing-library/angular
- **Location**: Test files co-located with components (`*.spec.ts`)
- **Coverage Requirements**: 85% threshold for branches, functions, lines, statements
- **Configuration File**: `apps/ui/jest.config.ts` with setupFilesAfterEnv pointing to test-setup.ts

**Testing Library Integration:**
```typescript
// Required testing imports
import { render, screen, fireEvent, waitFor } from '@testing-library/angular';
import { ComponentFixture, TestBed } from '@angular/core/testing';
import { signal } from '@angular/core';
```

**Coverage Configuration:**
```typescript
coverageThreshold: {
  global: {
    branches: 85,
    functions: 85,
    lines: 85,
    statements: 85
  }
}
```

### Component Testing Standards
[Source: docs/ui-architecture/frontend-developer-standards.md#testing-patterns]

**GameBoardComponent Test Requirements:**
```typescript
describe('GameBoardComponent Integration Tests', () => {
  let component: GameBoardComponent;
  let fixture: ComponentFixture<GameBoardComponent>;
  let mockGameService: jasmine.SpyObj<GameService>;
  
  beforeEach(async () => {
    const gameServiceSpy = jasmine.createSpyObj('GameService', [
      'makeMove', 'resetGame', 'getBoardState', 'getCurrentPlayer', 
      'getGameStatus', 'getWinningLine'
    ]);
    
    await TestBed.configureTestingModule({
      imports: [GameBoardComponent, CommonModule],
      providers: [
        { provide: GameService, useValue: gameServiceSpy }
      ]
    }).compileComponents();
    
    fixture = TestBed.createComponent(GameBoardComponent);
    component = fixture.componentInstance;
    mockGameService = TestBed.inject(GameService) as jasmine.SpyObj<GameService>;
  });
  
  // Required test cases for AC 1
  it('should render 3x3 grid with proper test IDs', () => {
    // Test implementation
  });
  
  it('should handle human player moves via cell clicks', () => {
    // Test implementation  
  });
  
  it('should display X win scenario with winning line highlight', () => {
    // Test implementation with positions [0,1,2]
  });
  
  it('should update game status during win scenario', () => {
    // Test implementation
  });
  
  it('should disable board after game ends', () => {
    // Test implementation
  });
});
```

**Test Data Setup Patterns:**
```typescript
// Game state factory functions for consistent test data
function createMockGameState(overrides: Partial<GameState> = {}): GameState {
  return {
    board: Array(9).fill(null),
    currentPlayer: 'X',
    status: 'playing',
    winner: null,
    winningLine: null,
    moveHistory: [],
    boardSize: 3,
    gameMode: 'human-vs-human',
    ...overrides
  };
}

function createXWinScenario(): GameState {
  return createMockGameState({
    board: ['X', 'X', 'X', 'O', 'O', null, null, null, null],
    status: 'won',
    winner: 'X',
    winningLine: [0, 1, 2]
  });
}
```

### Computer Player Testing Standards
[Source: docs/architecture/ADR-003-engine-design.md, libs/engine/src/lib/computer-player.spec.ts]

**ComputerPlayer Test Requirements:**
```typescript
describe('ComputerPlayer Optimization Tests', () => {
  let computerPlayer: ComputerPlayer;
  let mockEngine: jasmine.SpyObj<GameEngine>;
  
  beforeEach(() => {
    const engineSpy = jasmine.createSpyObj('GameEngine', [
      'isValidMove', 'applyMove', 'checkWinner', 'getAvailableMoves'
    ]);
    
    TestBed.configureTestingModule({
      providers: [
        ComputerPlayer,
        { provide: GameEngine, useValue: engineSpy }
      ]
    });
    
    computerPlayer = TestBed.inject(ComputerPlayer);
    mockEngine = TestBed.inject(GameEngine) as jasmine.SpyObj<GameEngine>;
  });
  
  // Required test cases for AC 2
  it('should choose immediate win opportunity', () => {
    // Test computer recognizes winning move
    const boardWithWinOpportunity = ['X', 'X', null, 'O', 'O', null, null, null, null];
    mockEngine.getAvailableMoves.and.returnValue([2, 5, 6, 7, 8]);
    mockEngine.checkWinner.and.returnValue({ winner: 'X', winningLine: [0, 1, 2] });
    
    const move = computerPlayer.selectMove(createMockGameState({ 
      board: boardWithWinOpportunity, 
      currentPlayer: 'X' 
    }));
    
    expect(move.position).toBe(2); // Winning position
  });
  
  it('should block opponent immediate win threat', () => {
    // Test computer blocks opponent win
    const boardWithThreat = ['O', 'O', null, 'X', null, null, null, null, null];
    mockEngine.getAvailableMoves.and.returnValue([2, 4, 5, 6, 7, 8]);
    
    const move = computerPlayer.selectMove(createMockGameState({ 
      board: boardWithThreat, 
      currentPlayer: 'X' 
    }));
    
    expect(move.position).toBe(2); // Blocking position
  });
  
  it('should make deterministic moves for testing', () => {
    // Test computer behavior is predictable
    const boardState = ['X', null, null, null, 'O', null, null, null, null];
    
    const move1 = computerPlayer.selectMove(createMockGameState({ 
      board: boardState, 
      currentPlayer: 'X' 
    }));
    const move2 = computerPlayer.selectMove(createMockGameState({ 
      board: boardState, 
      currentPlayer: 'X' 
    }));
    
    expect(move1.position).toBe(move2.position); // Deterministic
  });
});
```

### Integration Testing Patterns
[Source: docs/architecture/ADR-002-project-structure.md#testing-strategy-by-layer]

**GameService Integration Tests:**
```typescript
describe('GameService Integration', () => {
  let service: GameService;
  let mockEngine: jasmine.SpyObj<GameEngine>;
  let mockComputerPlayer: jasmine.SpyObj<ComputerPlayer>;
  
  beforeEach(() => {
    TestBed.configureTestingModule({
      providers: [
        GameService,
        { provide: GameEngine, useValue: createMockEngine() },
        { provide: ComputerPlayer, useValue: createMockComputerPlayer() }
      ]
    });
    
    service = TestBed.inject(GameService);
    mockEngine = TestBed.inject(GameEngine) as jasmine.SpyObj<GameEngine>;
    mockComputerPlayer = TestBed.inject(ComputerPlayer) as jasmine.SpyObj<ComputerPlayer>;
  });
  
  it('should complete human vs computer game flow', () => {
    // Test complete gameplay from start to finish
  });
  
  it('should handle board size changes with computer player', () => {
    // Test 3x3 to 4x4 transition maintains computer functionality
  });
  
  it('should reset game maintaining computer player mode', () => {
    // Test game reset preserves HvC mode
  });
});
```

### Test File Locations and Structure
[Source: docs/ui-architecture/project-structure.md]

**Files to Create:**
- `apps/ui/src/app/components/game-board/game-board.component.integration.spec.ts` - Component integration tests
- `libs/engine/src/lib/computer-player.optimization.spec.ts` - Computer player optimization tests
- `apps/ui/src/app/services/game.service.integration.spec.ts` - Service integration tests
- `apps/ui/src/test-helpers/game-state-factories.ts` - Test data factories
- `apps/ui/src/test-helpers/mock-providers.ts` - Mock service providers

**Files to Update:**
- `apps/ui/src/app/components/game-board/game-board.component.spec.ts` - Add integration test cases
- `libs/engine/src/lib/computer-player.spec.ts` - Add optimization test cases
- `apps/ui/src/app/services/game.service.spec.ts` - Add integration scenarios
- `apps/ui/jest.config.ts` - Update test patterns if needed

### Test Data and Mock Patterns
[Source: docs/ui-architecture/frontend-developer-standards.md#testing-patterns]

**Mock Provider Factory:**
```typescript
// apps/ui/src/test-helpers/mock-providers.ts
export function createMockGameService(): jasmine.SpyObj<GameService> {
  return jasmine.createSpyObj('GameService', [
    'makeMove', 'resetGame', 'getBoardState', 'getCurrentPlayer',
    'getGameStatus', 'getWinningLine', 'isGameOver', 'switchMode'
  ], {
    gameState: signal(createMockGameState()),
    currentPlayer: signal('X'),
    gameStatus: signal('playing'),
    boardCells: signal(Array(9).fill(null))
  });
}

export function createMockComputerPlayer(): jasmine.SpyObj<ComputerPlayer> {
  return jasmine.createSpyObj('ComputerPlayer', ['selectMove'], {
    difficulty: 'optimal'
  });
}
```

**Game State Factories:**
```typescript
// apps/ui/src/test-helpers/game-state-factories.ts
export class GameStateFactory {
  static createInitial(): GameState {
    return {
      board: Array(9).fill(null),
      currentPlayer: 'X',
      status: 'playing',
      winner: null,
      winningLine: null,
      moveHistory: [],
      boardSize: 3,
      gameMode: 'human-vs-human'
    };
  }
  
  static createXWinScenario(): GameState {
    return {
      ...this.createInitial(),
      board: ['X', 'X', 'X', 'O', 'O', null, null, null, null],
      status: 'won',
      winner: 'X',
      winningLine: [0, 1, 2]
    };
  }
  
  static createComputerWinOpportunity(): GameState {
    return {
      ...this.createInitial(),
      board: ['X', 'X', null, 'O', 'O', null, null, null, null],
      currentPlayer: 'X',
      gameMode: 'human-vs-computer'
    };
  }
  
  static createComputerBlockScenario(): GameState {
    return {
      ...this.createInitial(),
      board: ['O', 'O', null, 'X', null, null, null, null, null],
      currentPlayer: 'X',
      gameMode: 'human-vs-computer'
    };
  }
}
```

### Performance and Coverage Requirements
[Source: apps/ui/jest.config.ts]

**Coverage Standards:**
- **Branches**: 85% minimum coverage
- **Functions**: 85% minimum coverage  
- **Lines**: 85% minimum coverage
- **Statements**: 85% minimum coverage

**Test Performance:**
- Individual test execution under 100ms
- Full test suite under 30 seconds
- Mock dependencies to avoid external calls
- Use TestBed.configureTestingModule for Angular integration

**Test Organization:**
```typescript
// Proper test structure for maintainability
describe('GameBoardComponent', () => {
  describe('Rendering', () => {
    // Test rendering scenarios
  });
  
  describe('User Interaction', () => {
    // Test click handlers and user input
  });
  
  describe('Game State Integration', () => {
    // Test component integration with game state
  });
  
  describe('Win Scenarios', () => {
    // Test win condition handling
  });
});
```

### Testing

#### Testing Standards
[Source: docs/architecture/ADR-001-tech-stack.md#testing-infrastructure]

**Framework Configuration:**
- **Jest**: Unit and integration testing with Angular preset
- **Testing Library**: User-centric component testing approach
- **Coverage**: 85% threshold across all metrics (branches, functions, lines, statements)
- **Location**: Co-located test files with `.spec.ts` and `.integration.spec.ts` suffixes

**Test Execution Commands:**
```bash
# Run all tests
pnpm nx test ui

# Run tests with coverage
pnpm nx test ui --coverage

# Run specific test file
pnpm nx test ui --testPathPattern=game-board.component.spec.ts

# Run tests in watch mode
pnpm nx test ui --watch
```

**Component Testing Requirements:**
- Use TestBed.configureTestingModule for Angular dependency injection
- Mock all service dependencies with jasmine.createSpyObj
- Test component rendering, user interaction, and state integration
- Include proper cleanup in afterEach hooks
- Use Testing Library queries for user-centric test assertions

**Engine Testing Requirements:**
- Pure unit tests with no Angular dependencies
- Test optimal move selection algorithms
- Verify deterministic behavior for consistent testing
- Cover edge cases and error conditions
- Mock GameEngine dependencies for isolated testing

**Integration Testing Strategy:**
- Test complete user workflows from component to service to engine
- Verify computer player integration with UI components
- Test game mode transitions and board size changes
- Ensure proper error handling and user feedback

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-26 | 1.0 | Initial story creation from Epic 3.6 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet - Full Stack Developer Agent

### Debug Log References
- Fixed jasmine vs jest mocking conflicts in integration tests
- Resolved readonly GameState property issues in ComputerPlayer tests
- Fixed async timing issues in GameService integration tests
- Corrected component delegation pattern expectations in tests
- Fixed TypeScript build errors by excluding test-helpers from app compilation (tsconfig.app.json)

### Completion Notes
- **Task 1**: Created comprehensive GameBoardComponent integration tests with 19 test cases covering rendering, interaction, game state integration, win scenarios, accessibility, and animations. All tests pass.
- **Task 2**: Implemented ComputerPlayer optimization tests with 18 test cases covering win recognition, threat blocking, optimal moves, deterministic behavior, and edge cases. All tests pass.
- **Task 3**: Added GameService integration tests with 21 test cases covering human vs computer gameplay, board size changes, game reset functionality, error handling, and all game modes. All tests pass.
- **Coverage**: Achieved comprehensive test coverage with 143 UI tests and 333 engine tests, all passing
- **Quality**: All tests follow Jest best practices with proper mocking, async handling, and descriptive assertions

### File List
**New Files:**
- `apps/ui/src/test-helpers/game-state-factories.ts` - Test data factory functions for consistent GameState creation
- `apps/ui/src/test-helpers/mock-providers.ts` - Jest-based mock service providers with proper signal support
- `apps/ui/src/app/components/game-board/game-board.component.integration.spec.ts` - Comprehensive integration tests for GameBoardComponent

**Modified Files:**
- `libs/engine/src/lib/computer-player.spec.ts` - Added optimization tests for AC 2 requirements
- `apps/ui/src/app/services/game.service.spec.ts` - Added integration tests for AC coverage enhancement
- `apps/ui/tsconfig.app.json` - Excluded test-helpers directory from application build to fix E2E test compilation

## QA Results

*This section will be populated by the QA agent after implementation review*